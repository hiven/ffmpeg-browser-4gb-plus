<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFmpeg Segment Extractor</title>
    <script src="common.js"></script>
    <style>
        #thumbnailsContainer img {
            display: inline-block;
            margin: 0;
        }
        #thumbnailsContainer {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>FFmpeg Segment Extractor</h1>

    <input type="file" id="fileInput" accept="video/*">
    <button id="runButton" disabled>Extract Segment</button>

    <div id="tty" style="border: 1px solid #ccc; padding: 10px; margin-top: 20px; height: 200px; overflow-y: auto;"></div>

    <div id="outputLabel" style="margin-top: 20px; font-weight: bold;"></div>
    <div id="thumbnailsContainer" style="margin-top: 20px;"></div>

    <script>
        async function initializeFFmpeg() {
            try {
                await load(false, progress => {
                    console.log(`Loading FFmpeg: ${Math.round((progress.received / progress.total) * 100)}%`);
                });
                console.log("FFmpeg loaded successfully");
                document.getElementById('runButton').disabled = false;
            } catch (error) {
                console.error("Failed to load FFmpeg", error);
                alert("Error loading FFmpeg.");
            }
        }

        async function runCommand() {
            const fileInput = document.getElementById('fileInput');
            const outputLabel = document.getElementById('outputLabel');
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');

            if (!fileInput.files.length) {
                alert('Please select a file.');
                return;
            }

            const file = fileInput.files[0];
            const inputDir = '/input';
            const inputFile = `${inputDir}/${file.name}`;
            const thumbnailFile = '/thumbnail_%d.png';

            try {
                // Clear existing thumbnails
                while (thumbnailsContainer.firstChild) {
                    thumbnailsContainer.removeChild(thumbnailsContainer.firstChild);
                }

                cleanLog();

                outputLabel.textContent = "Calculating duration...";

                await ffmpeg.createDir(inputDir);
                await ffmpeg.mount('WORKERFS', { files: [file] }, inputDir);

                // Extract duration
                const durationArgs = ['-hide_banner', '-v', 'info', '-i', inputFile];
                await ffmpeg.exec(durationArgs);
                const logContent = document.getElementById('tty').innerText;
                const duration = extractDurationFromLog(logContent);
                const durationInSeconds = convertDurationToSeconds(duration);

                const interval = calculateInterval(durationInSeconds, 10);

                // Notify user that thumbnails are being generated
                outputLabel.textContent = "Generating thumbnails, please wait...";

                // Generate thumbnails
                const thumbnailArgs = [
                    '-skip_frame', 'nokey',
                    '-i', inputFile,
                    '-vf', `fps=1/${interval},scale=400:-1:flags=bilinear`,
                    '-flags2', 'fast',
                    '-an', '-sn', '-dn',
                    thumbnailFile,
                ];
                const thumbnailErr = await ffmpeg.exec(thumbnailArgs);

                if (thumbnailErr !== 0) {
                    log("<strong>Error generating thumbnails! Please see the log above.</strong>");
                } else {
                    log("Generating thumbnails...");
                    for (let i = 1; i <= 10; i++) {
                        const thumbnailData = await ffmpeg.readFile(`/thumbnail_${i}.png`);
                        const thumbnailURL = URL.createObjectURL(new Blob([thumbnailData.buffer], { type: "image/png" }));
                        const img = document.createElement('img');
                        img.src = thumbnailURL;
                        thumbnailsContainer.appendChild(img);
                    }
                }

                outputLabel.textContent = "Thumbnails generated successfully!";
                await ffmpeg.unmount(inputDir);
                await ffmpeg.deleteDir(inputDir);
            } catch (error) {
                console.error(error);
                outputLabel.textContent = "Error extracting segment. See console for details.";
            }
        }

        function extractDurationFromLog(log) {
            const regex = /Duration: (\d{2}:\d{2}:\d{2}).(\d+),/;
            const match = log.match(regex);
            return match ? match[1] : 'N/A';
        }

        function convertDurationToSeconds(duration) {
            if (duration === 'N/A') return duration;
            const [hours, minutes, seconds] = duration.split(':').map(Number);
            return (hours * 3600) + (minutes * 60) + seconds;
        }

        function calculateInterval(durationInSeconds, intervalsCount) {
            return durationInSeconds / intervalsCount;
        }

        document.getElementById('runButton').addEventListener('click', runCommand);

        initializeFFmpeg();
    </script>
</body>
</html>
