<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FFmpeg Segment Extractor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma/css/bulma.min.css">
  <style>
    /* Styles for thumbnails container */
    #thumbnailsContainer {
      display: flex;
      overflow-x: auto;
      gap: 0.5rem;
      padding: 1rem;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
    }
    #thumbnailsContainer img {
      border: 1px solid #ddd;
      border-radius: 0.25rem;
      width: 120px;
      height: auto;
    }
    #tty {
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      background: #fff;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title">FFmpeg Segment Extractor</h1>
      <div class="field">
        <label class="label" for="fileInput">Upload a Video File</label>
        <div class="control">
          <input class="input" type="file" id="fileInput" accept="video/*">
        </div>
      </div>
      <div class="field">
        <div class="control">
          <button class="button is-primary" id="runButton" disabled>Extract Segment</button>
        </div>
      </div>
      <div id="tty" class="box"></div>
      <div id="outputLabel" class="has-text-weight-bold mt-4"></div>
      <div id="metadataContainer" class="mt-4">
        <h2 class="subtitle">Video Metadata</h2>
        <ul id="metadataList"></ul>
      </div>
      <div id="thumbnailsContainer" class="mt-4"></div>
    </div>
  </section>
  <script type="module">
    const { load, ffmpeg, cleanLog, log } = window;
    const NUM_THUMBNAILS = 20;
    const THUMBNAIL_WIDTH = 400;
    const CROP_WIDTH = 300;
    const CROP_HEIGHT = 300;

    class FfmpegSegmentExtractor {
      constructor() {
        this.fileInput = document.getElementById('fileInput');
        this.runButton = document.getElementById('runButton');
        this.tty = document.getElementById('tty');
        this.outputLabel = document.getElementById('outputLabel');
        this.metadataList = document.getElementById('metadataList');
        this.thumbnailsContainer = document.getElementById('thumbnailsContainer');
      }

      static async init() {
        const extractor = new FfmpegSegmentExtractor();
        await extractor.loadFfmpeg();
        extractor.bindEvents();
      }

      async loadFfmpeg() {
        try {
          await load(false, ({ received, total }) => {
            const percent = Math.round((received / total) * 100);
            this.log(`[FFmpeg] Loading: ${percent}%`);
          });
          this.log('[FFmpeg] Loaded successfully');
          this.runButton.disabled = false;
        } catch (err) {
          this.log('[Error] Failed to load FFmpeg');
          alert('Error loading FFmpeg. Please refresh the page.');
        }
      }

      bindEvents() {
        this.runButton.addEventListener('click', () => this.extractThumbnails());
        this.fileInput.addEventListener('change', () => this.resetUI());
      }

      resetUI() {
        cleanLog();
        this.metadataList.replaceChildren();
        this.thumbnailsContainer.replaceChildren();
        this.outputLabel.textContent = '';
      }

      async extractThumbnails() {
        if (!this.fileInput.files.length) {
          alert('Please select a video file.');
          return;
        }
        const file = this.fileInput.files[0];
        const inputDir = '/input';
        const inputFilePath = `${inputDir}/${file.name}`;
        const thumbnailPattern = '/thumbnail_%d.png';

        this.resetUI();
        this.outputLabel.textContent = 'Generating thumbnails, please wait...';

        try {
          await ffmpeg.createDir(inputDir);
          await ffmpeg.mount('WORKERFS', { files: [file] }, inputDir);
          await ffmpeg.exec(['-hide_banner', '-v', 'info', '-i', inputFilePath]);
          const logText = this.tty.innerText;

          const durationSec = this.getDurationSeconds(logText);
          const interval = durationSec / NUM_THUMBNAILS;

          const metadata = this.parseMetadata(logText);
          this.displayMetadata(metadata);

          await this.generateThumbnails(inputFilePath, interval, thumbnailPattern);
          this.displayThumbnails();

        } catch (err) {
          console.error(err);
          this.outputLabel.textContent = '‚ùå Error extracting segment. Check console for details.';
        } finally {
          await ffmpeg.unmount(inputDir);
          await ffmpeg.deleteDir(inputDir);
        }
      }

      getDurationSeconds(log) {
        const match = log.match(/Duration: (\d{2}):(\d{2}):(\d{2})\.(\d+)/);
        if (!match) return 0;
        const [hrs, mins, secs] = match.slice(1, 4).map(Number);
        return hrs * 3600 + mins * 60 + secs;
      }

      parseMetadata(log) {
        const patterns = {
          'Duration': /Duration: (\d{2}:\d{2}:\d{2})\.(\d+)/,
          'Bitrate': /bitrate: (\d+ kb\/s)/,
          'Resolution': /, (\d{3,5}x\d{3,5}),/,
          'Framerate': /(\d+(\.\d+)?) fps/,
          'Video Codec': /Video: ([^,]+)/,
          'Audio Codec': /Audio: ([^,]+)/,
        };
        const meta = {};
        for (const [key, regex] of Object.entries(patterns)) {
          const m = log.match(regex);
          if (m) meta[key] = key === 'Duration' ? `${m[1]}.${m[2]}` : m[1];
        }
        return meta;
      }

      displayMetadata(meta) {
        this.metadataList.replaceChildren();
        for (const [key, value] of Object.entries(meta)) {
          const li = document.createElement('li');
          li.textContent = `${key}: ${value}`;
          this.metadataList.appendChild(li);
        }
      }

      async generateThumbnails(input, interval, outputPattern) {
        const args = [
          '-hide_banner',
          '-skip_frame', 'nokey',
          '-i', input,
          '-vf', `fps=1/${interval},scale=${THUMBNAIL_WIDTH}:-1:flags=bilinear,crop=${CROP_WIDTH}:${CROP_HEIGHT}:(iw-${CROP_WIDTH})/2:(ih-${CROP_HEIGHT})/2`,
          '-flags2', 'fast',
          '-an', '-sn', '-dn',
          outputPattern,
        ];
        const code = await ffmpeg.exec(args);
        if (code !== 0) throw new Error('FFmpeg thumbnail generation failed');
      }

      displayThumbnails() {
        this.thumbnailsContainer.replaceChildren();
        for (let i = 1; i <= NUM_THUMBNAILS; i++) {
          const data = ffmpeg.readFile(`/thumbnail_${i}.png`);
          const url = URL.createObjectURL(new Blob([data.buffer], { type: 'image/png' }));
          const img = document.createElement('img');
          img.src = url;
          this.thumbnailsContainer.appendChild(img);
        }
        this.outputLabel.textContent = '';
      }

      log(message) {
        log(message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => FfmpegSegmentExtractor.init());
  </script>
</body>
</html>
